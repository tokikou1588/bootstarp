(function(n){function r(t){return this.each(function(){var u=n(this),r=u.data(i.DATA_KEY),f=typeof t=="object"&&t;r?r.update(f):u.data(i.DATA_KEY,r=new i(this,f))})}var i=function(t,i){this.$element=n(t);this.options=n.extend({},i);this.init()},t;i.VERSION="3.1.0";i.Author="argo@163.com";i.DATA_KEY="lgb.SliderCaptcha";t=i.prototype;t.init=function(){this.initDOM();this.initImg();this.bindEvents()};t.initDOM=function(){var u=this.$element.find("canvas:first")[0].getContext("2d"),t=this.$element.find("canvas:last")[0],f=t.getContext("2d"),e=this.$element.find(".captcha-load"),i=this.$element.find(".captcha-footer"),o=i.find(".captcha-bar-bg"),s=this.$element.find(".captcha-bar"),r=this.$element.find(".captcha-bar-text"),h=this.$element.find(".captcha-refresh"),c=r.attr("data-text");n.extend(this,{canvas:u,block:t,bar:f,$load:e,$footer:i,$barLeft:o,$slider:s,$barText:r,$refresh:h,barText:c})};t.initImg=function(){var i=function(n,t){var i=this.options.sideLength,f=this.options.diameter,e=Math.PI,r=this.options.offsetX,u=this.options.offsetY;n.beginPath();n.moveTo(r,u);n.arc(r+i/2,u-f+2,f,.72*e,2.26*e);n.lineTo(r+i,u);n.arc(r+i+f-2,u+i/2,f,1.21*e,2.78*e);n.lineTo(r+i,u+i);n.lineTo(r,u+i);n.arc(r+f-2,u+i/2,f+.4,2.76*e,1.24*e,!0);n.lineTo(r,u);n.lineWidth=2;n.fillStyle="rgba(255, 255, 255, 0.7)";n.strokeStyle="rgba(255, 255, 255, 0.7)";n.stroke();n[t]();n.globalCompositeOperation="destination-over"},t=new Image,n;t.src=this.options.imageUrl;n=this;t.onload=function(){i.call(n,n.canvas,"fill");i.call(n,n.bar,"clip");n.canvas.drawImage(t,0,0,n.options.width,n.options.height);n.bar.drawImage(t,0,0,n.options.width,n.options.height);var r=n.options.offsetY-n.options.diameter*2-1,u=n.bar.getImageData(n.options.offsetX-3,r,n.options.barWidth,n.options.barWidth);n.block.width=n.options.barWidth;n.bar.putImageData(u,0,r)};t.onerror=function(){n.$load.text($load.attr("data-failed")).addClass("text-danger")}};t.bindEvents=function(){var n=this,t=0,i=0,r=[];this.$slider.drag(function(r){n.$barText.addClass("d-none");t=r.clientX||r.touches[0].clientX;i=r.clientY||r.touches[0].clientY},function(u){var o=u.clientX||u.touches[0].clientX,s=u.clientY||u.touches[0].clientY,f=o-t,h=s-i,e;if(f<0||f+40>n.options.width)return!1;n.$slider.css({left:f-1+"px"});e=(n.options.width-60)/(n.options.width-40)*f;n.block.style.left=e+"px";n.$footer.addClass("is-move");n.$barLeft.css({width:f+4+"px"});r.push(Math.round(h))},function(i){var f=i.clientX||i.changedTouches[0].clientX,u;n.$footer.removeClass("is-move");u=Math.ceil((n.options.width-60)/(n.options.width-40)*(f-t)+3);n.verify(u,r)});this.$refresh.on("click",function(){n.options.barText=n.$barText.attr("data-text")})};t.verify=function(n,t){var r=this.options.remoteObj.obj,u=this.options.remoteObj.method,i=this;r.invokeMethodAsync(u,n,t).then(function(n){n?(i.$footer.addClass("is-valid"),i.options.barText=i.$barText.attr("data-text")):(i.$footer.addClass("is-invalid"),setTimeout(function(){i.$refresh.trigger("click");i.options.barText=i.$barText.attr("data-try")},1e3))})};t.update=function(t){n.extend(this.options,t);this.resetCanvas();this.initImg();this.resetBar()};t.resetCanvas=function(){this.canvas.clearRect(0,0,this.options.width,this.options.height);this.bar.clearRect(0,0,this.options.width,this.options.height);this.block.width=this.options.width;this.block.style.left=0;this.$load.text(this.$load.attr("data-load")).removeClass("text-danger")};t.resetBar=function(){this.$footer.removeClass("is-invalid is-valid");this.$barText.text(this.options.barText).removeClass("d-none");this.$slider.css({left:"0px"});this.$barLeft.css({width:"0px"})};n.fn.sliderCaptcha=r;n.fn.sliderCaptcha.Constructor=i;n.extend({captcha:function(t,i,r,u){u.remoteObj={obj:i,method:r};n(t).sliderCaptcha(u)}})})(jQuery);